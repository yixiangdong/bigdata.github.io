<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement(o),n=t.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/e0740d98.js","daovoice"),daovoice("init",{app_id:"e0740d98"}),daovoice("update")</script><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css"><script src="/lib/pace/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"etop.work",root:"/",scheme:"Muse",version:"7.7.2",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:{enable:!0,onlypost:!1,loadingImg:"/uploads/loading.jpg"},pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"9133ZNYPST",apiKey:"438b8e1d3359f650966c28b8caf83dea",indexName:"yixiangdong_index",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!0,preload:!0},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="业务数仓搭建业务数仓架构图业务数仓系统流程设计"><meta property="og:type" content="article"><meta property="og:title" content="阿里云Dataworks+Maxcompute实时计算数据仓库方案之业务数仓搭建(二)"><meta property="og:url" content="https://etop.work/2020/03/20/ceshi2/index.html"><meta property="og:site_name" content="大数据商务智能(BI)专栏"><meta property="og:description" content="业务数仓搭建业务数仓架构图业务数仓系统流程设计"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584648329928.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584884841420.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893428690.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584884954626.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584885516491.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584885569395.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584885612740.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584885796233.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584885851653.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584885896615.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584885964562.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584886004636.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584886175005.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584886209804.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584886436237.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584886474174.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584886528871.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584886574879.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584886662733.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584886701603.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584886919588.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584886947876.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584887064689.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584887104680.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584887150706.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584887172517.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584887227050.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584887595660.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584887862971.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584888013602.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584888088744.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584888264329.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584890633172.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584890690877.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584890716157.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584891252868.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584891363222.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584891389484.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584891481964.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584891569954.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584891616692.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584891839724.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584891877673.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584891915067.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584892575877.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584892611381.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584892810119.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584892852910.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/584892876453.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893015966.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893058247.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893126473.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893193490.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893262155.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893324196.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893428690.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893490902.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893610335.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893708266.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893778309.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893815043.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893851471.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893888320.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893919037.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584893959779.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584894000037.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584894030944.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584894096874.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584894130606.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584894184531.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584894213762.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584894302665.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584894343806.png"><meta property="og:image" content="https://etop.work/2020/03/20/ceshi2/1584894384988.png"><meta property="article:published_time" content="2020-03-19T19:57:06.000Z"><meta property="article:modified_time" content="2020-03-24T09:10:25.723Z"><meta property="article:author" content="易向东"><meta property="article:tag" content="数据仓库"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://etop.work/2020/03/20/ceshi2/1584648329928.png"><link rel="canonical" href="https://etop.work/2020/03/20/ceshi2/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>阿里云Dataworks+Maxcompute实时计算数据仓库方案之业务数仓搭建(二) | 大数据商务智能(BI)专栏</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">大数据商务智能(BI)专栏</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">专注 系统 专业</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div id="algolia-pagination" class="algolia-pagination"></div></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://etop.work/2020/03/20/ceshi2/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="易向东"><meta itemprop="description" content="大数据商务智能(BI)方案设计"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="大数据商务智能(BI)专栏"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 阿里云Dataworks+Maxcompute实时计算数据仓库方案之业务数仓搭建(二)</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-03-20 03:57:06" itemprop="dateCreated datePublished" datetime="2020-03-20T03:57:06+08:00">2020-03-20</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-03-24 17:10:25" itemprop="dateModified" datetime="2020-03-24T17:10:25+08:00">2020-03-24</time></span><span id="/2020/03/20/ceshi2/" class="post-meta-item leancloud_visitors" data-flag-title="阿里云Dataworks+Maxcompute实时计算数据仓库方案之业务数仓搭建(二)" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <span class="post-meta-item-text">Valine：</span><a title="valine" href="/2020/03/20/ceshi2/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2020/03/20/ceshi2/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>22k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>20 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="业务数仓搭建"><a href="#业务数仓搭建" class="headerlink" title="业务数仓搭建"></a>业务数仓搭建</h1><h2 id="业务数仓架构图"><a href="#业务数仓架构图" class="headerlink" title="业务数仓架构图"></a>业务数仓架构图</h2><h3 id="业务数仓系统流程设计"><a href="#业务数仓系统流程设计" class="headerlink" title="业务数仓系统流程设计"></a>业务数仓系统流程设计</h3><p><img data-src="1584648329928.png" alt="系统业务流程设计"></p><a id="more"></a><h3 id="业务表结构"><a href="#业务表结构" class="headerlink" title="业务表结构"></a>业务表结构</h3><p><img data-src="1584884841420.png" alt="业务表结构"></p><h3 id="开发界面"><a href="#开发界面" class="headerlink" title="开发界面"></a>开发界面</h3><p><img data-src="1584893428690.png" alt="开发界面"></p><h3 id="业务数仓分层"><a href="#业务数仓分层" class="headerlink" title="业务数仓分层"></a>业务数仓分层</h3><p>业务数仓分层</p><h3 id="ODS层"><a href="#ODS层" class="headerlink" title="ODS层"></a>ODS层</h3><p><img data-src="1584884954626.png" alt="业务数仓分层 "></p><p>1) 在临时查询中统一执行建表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;ods_order_info_di&#96; (</span><br><span class="line">&#96;id&#96; string COMMENT &#39;订单编号&#39;,</span><br><span class="line">&#96;total_amount&#96; double COMMENT &#39;订单金额&#39;,</span><br><span class="line">&#96;order_status&#96; string COMMENT &#39;订单状态&#39;,</span><br><span class="line">&#96;user_id&#96; string COMMENT &#39;用户 id&#39;,</span><br><span class="line">&#96;payment_way&#96; string COMMENT &#39;支付方式&#39;,</span><br><span class="line">&#96;out_trade_no&#96; string COMMENT &#39;支付流水号&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;创建时间&#39;,</span><br><span class="line">&#96;operate_time&#96; string COMMENT &#39;操作时间&#39;,</span><br><span class="line">&#96;province_id&#96; string COMMENT &#39;省份&#39;</span><br><span class="line">)</span><br><span class="line">COMMENT &#39;订单表&#39;</span><br><span class="line">PARTITIONED BY (ds string);</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;ods_order_detail_di&#96; (</span><br><span class="line">&#96;id&#96; string COMMENT &#39;明细 id&#39;,</span><br><span class="line">&#96;order_id&#96; string COMMENT &#39;订单 id&#39;,</span><br><span class="line">&#96;sku_id&#96; string COMMENT &#39;商品 id&#39;,</span><br><span class="line">&#96;sku_name&#96; string COMMENT &#39;商品名称&#39;,</span><br><span class="line">&#96;order_price&#96; double COMMENT &#39;购买价格&#39;,</span><br><span class="line">&#96;sku_num&#96; bigint COMMENT &#39;购物数量&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;创建时间&#39;</span><br><span class="line">)</span><br><span class="line">COMMENT &#39;订单明细&#39;</span><br><span class="line">PARTITIONED BY (ds string);</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;ods_sku_info_df&#96; (</span><br><span class="line">&#96;id&#96; string COMMENT &#39;skuid&#39;,</span><br><span class="line">&#96;spu_id&#96; string COMMENT &#39;spuid&#39;,</span><br><span class="line">&#96;price&#96; double COMMENT &#39;价格&#39;,</span><br><span class="line">&#96;sku_name&#96; string COMMENT &#39;商品名称&#39;,</span><br><span class="line">&#96;sku_desc&#96; string COMMENT &#39;商品描述&#39;,</span><br><span class="line">&#96;weight&#96; double COMMENT &#39;重量(千克)&#39;,</span><br><span class="line">&#96;tm_id&#96; string COMMENT &#39;品牌 id&#39;,</span><br><span class="line">&#96;category3_id&#96; string COMMENT &#39;品类 id&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;创建时间&#39;</span><br><span class="line">)</span><br><span class="line">COMMENT &#39;商品信息&#39;</span><br><span class="line">PARTITIONED BY (ds string);</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;ods_user_info_df&#96; (</span><br><span class="line">&#96;id&#96; string COMMENT &#39;用户 id&#39;,</span><br><span class="line">&#96;name&#96; string COMMENT &#39;姓名&#39;,</span><br><span class="line">&#96;birthday&#96; string COMMENT &#39;生日&#39;,</span><br><span class="line">&#96;gender&#96; string COMMENT &#39;性别&#39;,</span><br><span class="line">&#96;email&#96; string COMMENT &#39;邮箱&#39;,</span><br><span class="line">&#96;user_level&#96; string COMMENT &#39;用户等级&#39;,</span><br><span class="line">&#96;create_time&#96; string COMMENT &#39;创建时间&#39;</span><br><span class="line">)</span><br><span class="line">COMMENT &#39;用户信息&#39;</span><br><span class="line">PARTITIONED BY (ds string);</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;ods_base_category3_df&#96; (</span><br><span class="line">&#96;id&#96; string COMMENT &#39;三级品类 id&#39;,</span><br><span class="line">&#96;name&#96; string COMMENT &#39;名称&#39;,</span><br><span class="line">&#96;category2_id&#96; string COMMENT &#39;二级品类 id&#39;</span><br><span class="line">)</span><br><span class="line">COMMENT &#39;三级品类信息&#39;</span><br><span class="line">PARTITIONED BY (ds string);</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;ods_base_trademark_df&#96; (</span><br><span class="line">&#96;tm_id&#96; string COMMENT &#39;品牌 id&#39;,</span><br><span class="line">&#96;tm_name&#96; string COMMENT &#39;名称&#39;</span><br><span class="line">)</span><br><span class="line">COMMENT &#39;品牌信息&#39;</span><br><span class="line">PARTITIONED BY (ds string);</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;ods_base_category1_df&#96; (</span><br><span class="line">&#96;id&#96; string COMMENT &#39;一级品类 id&#39;,</span><br><span class="line">&#96;name&#96; string COMMENT &#39;名称&#39;</span><br><span class="line">)</span><br><span class="line">COMMENT &#39;一级品类信息&#39;</span><br><span class="line">PARTITIONED BY (ds string);</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;ods_base_category2_df&#96; (</span><br><span class="line">&#96;id&#96; string COMMENT &#39;二级品类 id&#39;,</span><br><span class="line">&#96;name&#96; string COMMENT &#39;名称&#39;,</span><br><span class="line">&#96;category1_id&#96; string COMMENT &#39;一级品类 id&#39;</span><br><span class="line">)</span><br><span class="line">COMMENT &#39;二级品类信息&#39;</span><br><span class="line">PARTITIONED BY (ds string);</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;ods_payment_info_di&#96; (</span><br><span class="line">&#96;id&#96; bigint COMMENT &#39;编号&#39;,</span><br><span class="line">&#96;out_trade_no&#96; string COMMENT &#39;对外业务编号&#39;,</span><br><span class="line">&#96;order_id&#96; string COMMENT &#39;订单编号&#39;,</span><br><span class="line">&#96;user_id&#96; string COMMENT &#39;用户编号&#39;,</span><br><span class="line">&#96;alipay_trade_no&#96; string COMMENT &#39;支付宝交易流水编号&#39;,</span><br><span class="line">&#96;total_amount&#96; double COMMENT &#39;支付金额&#39;,</span><br><span class="line">&#96;subject&#96; string COMMENT &#39;交易内容&#39;,</span><br><span class="line">&#96;payment_type&#96; string COMMENT &#39;支付类型&#39;,</span><br><span class="line">&#96;payment_time&#96; string COMMENT &#39;支付时间&#39;</span><br><span class="line">)</span><br><span class="line">COMMENT &#39;支付流水表&#39;</span><br><span class="line">PARTITIONED BY (ds string);</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;ods_base_region_df&#96; (</span><br><span class="line">&#96;id&#96; bigint COMMENT &#39;地区 id&#39;,</span><br><span class="line">&#96;region_name&#96; string COMMENT &#39;地区名称&#39;</span><br><span class="line">)</span><br><span class="line">COMMENT &#39;地区&#39;</span><br><span class="line">PARTITIONED BY (ds string);</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;ods_base_province_df&#96; (</span><br><span class="line">&#96;id&#96; bigint COMMENT &#39;品牌 id&#39;,</span><br><span class="line">&#96;name&#96; string COMMENT &#39;名称&#39;,</span><br><span class="line">&#96;region_id&#96; bigint COMMENT &#39;地区 id&#39;</span><br><span class="line">)</span><br><span class="line">COMMENT &#39;省份&#39;</span><br><span class="line">PARTITIONED BY (ds string);</span><br></pre></td></tr></table></figure><p>2) 在表管理里面查看创建的表</p><p><img data-src="1584885516491.png" alt="查看建的表"></p><p>3）数据开发-&gt;ods-&gt;导入表</p><p><img data-src="1584885569395.png" alt="导入表 "></p><p>4）选择刚创建的所有表</p><p><img data-src="1584885612740.png" alt="选择刚创建的所有表"></p><h3 id="数据同步"><a href="#数据同步" class="headerlink" title="数据同步"></a>数据同步</h3><p>目前 MySQL 里面的数据已经有了， ODS 层表也已经建好，现在需要创建一个脚本，将MySQL 中数据同步到 ODS 层对应的表。</p><h4 id="建立数据同步节点"><a href="#建立数据同步节点" class="headerlink" title="建立数据同步节点"></a>建立数据同步节点</h4><p>1）数据集成-&gt;新建数据集成节点-&gt;数据同步</p><p><img data-src="1584885796233.png" alt="数据同步"></p><p>2）填写节点名称（ 表名+后缀， 见名知意就好，例如： ods_user_info_sync）</p><p><img data-src="1584885851653.png" alt="表名+后缀"></p><p>3）鼠标悬浮在选择数据源右侧的问号上-&gt;数据源进行新建操作</p><p><img data-src="1584885896615.png" alt="新建数据源"></p><p>4） 点击新增数据源-&gt;点击 MySQL</p><p><img data-src="1584885964562.png" alt="MySQL数据源"></p><p>5） 配置新增 MySQL 数据源</p><p><img data-src="1584886004636.png" alt="配置新增 MySQL数据源"></p><p>（ 1）数据源名称：可以任意取，这里取的 gmall_rds<br>（ 2） RDS 实例 ID： 根据问号的提示获取， 每个人的不一样。 rm-bp1t1li837a1v9gb8</p><p>（3） RDS 实例主账号 ID： 根据问号提示获取，每个人的不一样。 1902761552218725</p><p>（ 4）数据库名： 要连接的数据库名称， 我这里是 gmall<br>（ 5）用户名、密码：要连接的数据库的用户名和密码<br>（ 6）白名单配置：因为要用 MaxCompute 访问 RDS 所以要给 RDS 增加对应的白名单IP 地址。</p><p>a）点击点我查看如何添加白名单按钮</p><p><img data-src="1584886175005.png" alt="添加白名单按钮"></p><p>b）根据购买的 RDS 服务器地址，选择对应 IP 地址</p><p><img data-src="1584886209804.png" alt="选择对应 IP 地址"></p><p>c）在 RDS 中添加白名单</p><p><img data-src="1584886436237.png" alt="添加白名单"></p><p><img data-src="1584886474174.png" alt="添加白名单"></p><p>6） 配置完新增 MySQL 数据源， 就会在数据集成窗口发现增加了一个 gmall_rds 数据源</p><p><img data-src="1584886528871.png" alt="检查添加的数据源"></p><p>7）再次回到 DataStudio 工作空间，发现就可以选择数据源了</p><p><img data-src="1584886574879.png" alt="在DataStudio工作空间选择数据源"></p><p>7）配置数据去向数据源-&gt;鼠标悬浮问号上面-&gt;点击数据源进行新建操作-&gt;新增数据源<br>MaxCompute（ ODPS）</p><p><img data-src="1584886662733.png" alt="新增数据源MaxCompute"></p><p><img data-src="1584886701603.png" alt="新增数据源MaxCompute"></p><p>8）配置 MaxCompute 数据源详情</p><p><img data-src="1584886919588.png" alt="配置 MaxCompute 数据源详情"></p><p><img data-src="1584886947876.png" alt="查看配置的MaxCompute 数据源"></p><h3 id="每日全量表同步"><a href="#每日全量表同步" class="headerlink" title="每日全量表同步"></a>每日全量表同步</h3><p>用户表同步策略：每日全量<br>每 日 全 量 导 入 的 表 包 括 ：</p><p>ods_user_info 、</p><p>ods_base_category1</p><p> ods_base_category2<br>ods_base_category3</p><p>ods_base_province</p><p> ods_base_region</p><p>ods_base_trademark</p><p> ods_sku_info<br>1）配置完数据源后-&gt;点击运行（点击运行前，检查字段映射关系）</p><p><img data-src="1584887064689.png" alt="检查字段映射关系"></p><p><img data-src="1584887104680.png" alt="检查字段映射关系"></p><p><img data-src="1584887150706.png" alt="检查字段映射关系"></p><p><img data-src="1584887172517.png" alt="自定义参数"></p><p>2）临时查询，验证结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from ods_user_info_df where ds&#x3D;&#39;20191008&#39;;</span><br></pre></td></tr></table></figure><p><img data-src="1584887227050.png" alt="临时查询结果"></p><p>3）重复执行步骤 1-2，依次导入：</p><p>ods_base_category1</p><p>ods_base_category2</p><p>ods_base_category3<br>ods_base_province</p><p>ods_base_region</p><p>ods_base_trademark</p><p>ods_sku_info</p><h3 id="每日增量表同步"><a href="#每日增量表同步" class="headerlink" title="每日增量表同步"></a>每日增量表同步</h3><p>1）同步策略：每日增量</p><p>每日新增的表包括： ods_order_detail</p><p><img data-src="1584887595660.png" alt="每日新增的表"></p><p>每日增量的区别就是要按照日期进行过滤，只筛选出今天新产生的数据条件：</p><p>DATE_FORMAT(create_time,’%Y%m%d’)=’${bizdate}’</p><p>注意：此处必须是 MySql 的函数语法，不是 Hive 的。 ${bizdate}是系统自带参数用于取前一天的日期。</p><p>$[bizdate]是系统自带参数用于取当天的日期。</p><p>2）临时查询，验证结果</p><p>select * from ods_order_detail_di WHERE ds=’20191008’;</p><h3 id="每日新增及变化表同步"><a href="#每日新增及变化表同步" class="headerlink" title="每日新增及变化表同步"></a>每日新增及变化表同步</h3><p>1）同步策略：每日新增及变化</p><p>每日新增及变化的表包括： ods_order_info</p><p><img data-src="1584887862971.png" alt="每日新增及变化的表"></p><p>条件</p><p>DATE_FORMAT(create_time,’%Y%m%d’)=’${bizdate}’ or<br>DATE_FORMAT(operate_time,’%Y%m%d’)=’${bizdate}’</p><p>2）临时查询，验证结果</p><p>select * from ods_order_info_di WHERE ds=’20191008’;</p><p><img data-src="1584888013602.png" alt="查询结果"></p><p>ODS 层调度</p><p>把节点从左侧拖放至右侧，按照上下游的关系用线连接好。</p><p><img data-src="1584888088744.png" alt="连线"></p><h3 id="DWD-层"><a href="#DWD-层" class="headerlink" title="DWD 层"></a>DWD 层</h3><p>DWD 层，一般是对 ODS 层数据进行一定的清洗加工，如果是面对关系导入过来的数据表，还要把原本的关系型表结构，进行一定程度的维度退化。作为更易处理的明细数据。<br>比如：</p><p>ODS 地区 + ODS 省份=&gt; DWD 省份地区<br>ODS 商品信息 + ODS 品牌 + ODS 商品一级分类 + ODS 商品二级分类 + ODS 商品 三级分类=&gt;DWD 商品信息</p><p>DWD 层表结构如下图所示</p><p><img data-src="1584888264329.png" alt="DWD 层表结构"></p><h4 id="建表语句"><a href="#建表语句" class="headerlink" title="建表语句"></a>建表语句</h4><p>1）临时查询中，执行建表语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`dwd_order_info_di`</span> (</span><br><span class="line"><span class="string">`id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'订单 id'</span>,</span><br><span class="line"><span class="string">`total_amount`</span> <span class="keyword">double</span> <span class="keyword">COMMENT</span> <span class="string">'订单总额'</span>,</span><br><span class="line"><span class="string">`order_status`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">' 1 未支付 2 已支付 3 已发货 4 已</span></span><br><span class="line"><span class="string">收货 5 完成'</span>,</span><br><span class="line"><span class="string">`user_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'用户 id'</span>,</span><br><span class="line"><span class="string">`payment_way`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'付款方式'</span>,</span><br><span class="line"><span class="string">`out_trade_no`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'订单流失号'</span>,</span><br><span class="line"><span class="string">`province_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'省市 id'</span>,</span><br><span class="line"><span class="string">`create_time`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line"><span class="string">`operate_time`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'修改时间'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">'订单表'</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (ds <span class="keyword">string</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`dwd_order_detail_di`</span> (</span><br><span class="line"><span class="string">`id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'明细 id'</span>,</span><br><span class="line"><span class="string">`order_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'订单 id'</span>,</span><br><span class="line"><span class="string">`user_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'用户 id'</span>,</span><br><span class="line"><span class="string">`sku_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品 id'</span>,</span><br><span class="line"><span class="string">`sku_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品名称'</span>,</span><br><span class="line"><span class="string">`order_price`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'购买价格'</span>,</span><br><span class="line"><span class="string">`sku_num`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'购物数量'</span>,</span><br><span class="line"><span class="string">`province_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'省市 id'</span>,</span><br><span class="line"><span class="string">`create_time`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">'订单明细'</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (ds <span class="keyword">string</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`dim_sku_info_df`</span> (</span><br><span class="line"><span class="string">`id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品 id'</span>,</span><br><span class="line"><span class="string">`spu_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'spuid'</span>,</span><br><span class="line"><span class="string">`price`</span> <span class="keyword">double</span> <span class="keyword">COMMENT</span> <span class="string">'商品价格'</span>,</span><br><span class="line"><span class="string">`sku_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品名称'</span>,</span><br><span class="line"><span class="string">`sku_desc`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品描述'</span>,</span><br><span class="line"><span class="string">`weight`</span> <span class="keyword">double</span> <span class="keyword">COMMENT</span> <span class="string">'重量'</span>,</span><br><span class="line"><span class="string">`tm_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'品牌 id'</span>,</span><br><span class="line"><span class="string">`tm_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'品牌名称'</span>,</span><br><span class="line"><span class="string">`category3_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'三级分类 id'</span>,</span><br><span class="line"><span class="string">`category2_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'二级分类 id'</span>,</span><br><span class="line"><span class="string">`category1_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'一级分类 id'</span>,</span><br><span class="line"><span class="string">`category3_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'三级分类名称'</span>,</span><br><span class="line"><span class="string">`category2_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'二级分类名称'</span>,</span><br><span class="line"><span class="string">`category1_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'一级分类名称'</span>,</span><br><span class="line"><span class="string">`create_time`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">'商品表信息'</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (ds <span class="keyword">string</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`dim_user_info_df`</span> (</span><br><span class="line"><span class="string">`id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'id'</span>,</span><br><span class="line"><span class="string">`name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'用户名称'</span>,</span><br><span class="line"><span class="string">`birthday`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'生日'</span>,</span><br><span class="line"><span class="string">`gender`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'性别'</span>,</span><br><span class="line"><span class="string">`email`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'邮箱'</span>,</span><br><span class="line"><span class="string">`user_level`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'等级'</span>,</span><br><span class="line"><span class="string">`create_time`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'注册时间'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">'用户信息表'</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (ds <span class="keyword">string</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`dim_base_province_df`</span> (</span><br><span class="line"><span class="string">`id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'id'</span>,</span><br><span class="line"><span class="string">`province_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'省市名称'</span>,</span><br><span class="line"><span class="string">`region_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'地区 id'</span>,</span><br><span class="line"><span class="string">`region_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'地区名称'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">'地区省市表'</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (ds <span class="keyword">string</span>);</span><br></pre></td></tr></table></figure><p>2）在表管理里面查看创建的表</p><p><img data-src="1584890633172.png" alt="查看创建的表"></p><p>3）数据开发-&gt;dwd-&gt;导入表</p><p><img data-src="1584890690877.png" alt="导入表"></p><p>4）选择刚创建的所有表</p><p><img data-src="1584890716157.png" alt="选择刚创建的所有表 "></p><h4 id="手动将数据导入-DWD-层"><a href="#手动将数据导入-DWD-层" class="headerlink" title="手动将数据导入 DWD 层"></a>手动将数据导入 DWD 层</h4><p>1）在临时查询中执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">Insert overwrite table dwd_order_info_di partition(ds)</span><br><span class="line">select id,</span><br><span class="line">total_amount,</span><br><span class="line">order_status,</span><br><span class="line">user_id,</span><br><span class="line">payment_way,</span><br><span class="line">out_trade_no,</span><br><span class="line">province_id,</span><br><span class="line">create_time,</span><br><span class="line">operate_time,</span><br><span class="line">ds</span><br><span class="line">from ods_order_info_di</span><br><span class="line">where ds&#x3D;&#39;$&#123;bizdate&#125;&#39; and id is not null;</span><br><span class="line">insert overwrite table dwd_order_detail_di partition(ds)</span><br><span class="line">select od.id,</span><br><span class="line">order_id,</span><br><span class="line">oi.user_id,</span><br><span class="line">sku_id,</span><br><span class="line">sku_name,</span><br><span class="line">order_price,</span><br><span class="line">sku_num,</span><br><span class="line">oi.province_id,</span><br><span class="line">od.create_time,</span><br><span class="line">od.ds</span><br><span class="line">from ods_order_detail_di od join ods_order_info_di oi</span><br><span class="line">on od.order_id &#x3D; oi.id and oi.ds &#x3D; &#39;$&#123;bizdate&#125;&#39;</span><br><span class="line">and od.ds &#x3D; &#39;$&#123;bizdate&#125;&#39; and od.id is not null;</span><br><span class="line">insert overwrite table dim_sku_info_df partition(ds)</span><br><span class="line">select</span><br><span class="line">sku.id,</span><br><span class="line">sku.spu_id,</span><br><span class="line">sku.price,</span><br><span class="line">sku.sku_name,</span><br><span class="line">sku.sku_desc,</span><br><span class="line">sku.weight,</span><br><span class="line">sku.tm_id,</span><br><span class="line">tm.tm_name,</span><br><span class="line">sku.category3_id,</span><br><span class="line">c2.id category2_id ,</span><br><span class="line">c1.id category1_id,</span><br><span class="line">c3.name category3_name,</span><br><span class="line">c2.name category2_name,</span><br><span class="line">c1.name category1_name,</span><br><span class="line">sku.create_time,</span><br><span class="line">sku.ds</span><br><span class="line">from</span><br><span class="line">(</span><br><span class="line">select *</span><br><span class="line">from ods_sku_info_df</span><br><span class="line">where ds&#x3D;&#39;$&#123;bizdate&#125;&#39; and id is not null</span><br><span class="line">) sku</span><br><span class="line">join ods_base_category3_df c3 on sku.category3_id &#x3D; c3.id and</span><br><span class="line">c3.ds &#x3D; &#39;$&#123;bizdate&#125;&#39;</span><br><span class="line">join ods_base_category2_df c2 on c3.category2_id &#x3D; c2.id and</span><br><span class="line">c2.ds &#x3D; &#39;$&#123;bizdate&#125;&#39;</span><br><span class="line">join ods_base_category1_df c1 on c2.category1_id &#x3D; c1.id and</span><br><span class="line">c1.ds &#x3D; &#39;$&#123;bizdate&#125;&#39;</span><br><span class="line">join ods_base_trademark_df tm on tm.tm_id &#x3D; sku.tm_id and tm.ds</span><br><span class="line">&#x3D; &#39;$&#123;bizdate&#125;&#39;;</span><br><span class="line">insert overwrite table dim_user_info_df partition(ds)</span><br><span class="line">select id,</span><br><span class="line">name ,</span><br><span class="line">birthday,</span><br><span class="line">gender,</span><br><span class="line">email,</span><br><span class="line">user_level,</span><br><span class="line">create_time,</span><br><span class="line">ds from ods_user_info_df</span><br><span class="line">where ds&#x3D;&#39;$&#123;bizdate&#125;&#39; and id is not null;</span><br><span class="line">insert overwrite table dim_base_province_df PARTITION (ds)</span><br><span class="line">select</span><br><span class="line">p.id,</span><br><span class="line">p.name,</span><br><span class="line">p.region_id,</span><br><span class="line">r.region_name,</span><br><span class="line">p.ds</span><br><span class="line">from ods_base_province_df p join ods_base_region_df r</span><br><span class="line">on p.region_id &#x3D; r.id and p.ds&#x3D;&#39;$&#123;bizdate&#125;&#39; and r.ds &#x3D;</span><br><span class="line">&#39;$&#123;bizdate&#125;&#39;;</span><br></pre></td></tr></table></figure><p>2）在临时查询中查询结果</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> dwd_order_info_di <span class="keyword">where</span> ds=<span class="string">'20191008'</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> dwd_order_detail_di <span class="keyword">where</span> ds=<span class="string">'20191008'</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> dim_sku_info_df <span class="keyword">where</span> ds=<span class="string">'20191008'</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> dim_user_info_df <span class="keyword">where</span> ds=<span class="string">'20191008'</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> dim_base_province_df <span class="keyword">where</span> ds=<span class="string">'20191008'</span>;</span><br></pre></td></tr></table></figure><h3 id="数据导入脚本"><a href="#数据导入脚本" class="headerlink" title="数据导入脚本"></a>数据导入脚本</h3><p>1）编写 dwd_order_info_di 表脚本</p><p>（1）在流程中加入一个数据开发脚本</p><p><img data-src="1584891252868.png" alt="加入一个数据开发脚本"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Insert</span> overwrite <span class="keyword">table</span> dwd_order_info_di <span class="keyword">partition</span>(ds)</span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">id</span>,</span><br><span class="line">total_amount,</span><br><span class="line">order_status,</span><br><span class="line">user_id,</span><br><span class="line">payment_way,</span><br><span class="line">out_trade_no,</span><br><span class="line">province_id,</span><br><span class="line">create_time,</span><br><span class="line">operate_time,</span><br><span class="line">ds</span><br><span class="line"><span class="keyword">from</span> ods_order_info_di</span><br><span class="line"><span class="keyword">where</span> ds=<span class="string">'$&#123;bizdate&#125;'</span> <span class="keyword">and</span> <span class="keyword">id</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>（2）配置参数<br>点击调度配置-&gt; bizdate=${yyyymmdd}</p><p>2）编写 dwd_order_detail_di 表脚本<br>（1）新建节点 dwd_order_detail_di_sql</p><p><img data-src="1584891363222.png" alt="新建节点"></p><p><img data-src="1584891389484.png" alt="新建节点"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dwd_order_detail_di <span class="keyword">partition</span>(ds)</span><br><span class="line"><span class="keyword">select</span> od.id,</span><br><span class="line">order_id,</span><br><span class="line">oi.user_id,</span><br><span class="line">sku_id,</span><br><span class="line">sku_name,</span><br><span class="line">order_price,</span><br><span class="line">sku_num,</span><br><span class="line">oi.province_id,</span><br><span class="line">od.create_time,</span><br><span class="line">od.ds</span><br><span class="line"><span class="keyword">from</span> ods_order_detail_di od <span class="keyword">join</span> ods_order_info_di oi</span><br><span class="line"><span class="keyword">on</span> od.order_id = oi.id <span class="keyword">and</span> oi.ds = <span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">and</span> od.ds = <span class="string">'$&#123;bizdate&#125;'</span> <span class="keyword">and</span> od.id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>(2）配置参数<br>点击调度配置-&gt; bizdate=${yyyymmdd}</p><p>3）编写 dim_sku_info_df 表脚本<br>（ 1）新建节点 dim_sku_info_df_sql</p><p><img data-src="1584891481964.png" alt="新建节点"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dim_sku_info_df <span class="keyword">partition</span>(ds)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">sku.id,</span><br><span class="line">sku.spu_id,</span><br><span class="line">sku.price,</span><br><span class="line">sku.sku_name,</span><br><span class="line">sku.sku_desc,</span><br><span class="line">sku.weight,</span><br><span class="line">sku.tm_id,</span><br><span class="line">tm.tm_name,</span><br><span class="line">sku.category3_id,</span><br><span class="line">c2.id category2_id ,</span><br><span class="line">c1.id category1_id,</span><br><span class="line">c3.name category3_name,</span><br><span class="line">c2.name category2_name,</span><br><span class="line">c1.name category1_name,</span><br><span class="line">sku.create_time,</span><br><span class="line">sku.ds</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> ods_sku_info_df</span><br><span class="line"><span class="keyword">where</span> ds=<span class="string">'$&#123;bizdate&#125;'</span> <span class="keyword">and</span> <span class="keyword">id</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">) sku</span><br><span class="line"><span class="keyword">join</span> ods_base_category3_df c3 <span class="keyword">on</span> sku.category3_id = c3.id <span class="keyword">and</span></span><br><span class="line">c3.ds = <span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">join</span> ods_base_category2_df c2 <span class="keyword">on</span> c3.category2_id = c2.id <span class="keyword">and</span></span><br><span class="line">c2.ds = <span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">join</span> ods_base_category1_df c1 <span class="keyword">on</span> c2.category1_id = c1.id <span class="keyword">and</span></span><br><span class="line">c1.ds = <span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">join</span> ods_base_trademark_df tm <span class="keyword">on</span> tm.tm_id = sku.tm_id <span class="keyword">and</span> tm.ds</span><br><span class="line">= <span class="string">'$&#123;bizdate&#125;'</span>;</span><br></pre></td></tr></table></figure><p>(2）配置参数<br>点击调度配置-&gt; bizdate=${yyyymmdd}</p><p>4）编写 dim_user_info_df 表脚本</p><p>（ 1）新建节点 dim_user_info_df_sql</p><p><img data-src="1584891569954.png" alt="新建节点"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dim_user_info_df <span class="keyword">partition</span>(ds)</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,</span><br><span class="line"><span class="keyword">name</span> ,</span><br><span class="line">birthday,</span><br><span class="line">gender,</span><br><span class="line">email,</span><br><span class="line">user_level,</span><br><span class="line">create_time,</span><br><span class="line">ds <span class="keyword">from</span> ods_user_info_df</span><br><span class="line"><span class="keyword">where</span> ds=<span class="string">'$&#123;bizdate&#125;'</span> <span class="keyword">and</span> <span class="keyword">id</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>（ 2）配置参数<br>点击调度配置-&gt; bizdate=${yyyymmdd}<br>5）编写 dim_base_province_df 表脚本<br>（ 1）新建节点 dim_base_province_df_sql</p><p><img data-src="1584891616692.png" alt="新建节点"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dim_base_province_df <span class="keyword">PARTITION</span> (ds)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">p.id,</span><br><span class="line">p.name,</span><br><span class="line">p.region_id,</span><br><span class="line">r.region_name,</span><br><span class="line">p.ds</span><br><span class="line"><span class="keyword">from</span> ods_base_province_df p <span class="keyword">join</span> ods_base_region_df r</span><br><span class="line"><span class="keyword">on</span> p.region_id = r.id <span class="keyword">and</span> p.ds=<span class="string">'$&#123;bizdate&#125;'</span> <span class="keyword">and</span> r.ds =</span><br><span class="line"><span class="string">'$&#123;bizdate&#125;'</span>;</span><br></pre></td></tr></table></figure><p>（ 2）配置参数<br>点击调度配置-&gt; bizdate=${yyyymmdd}</p><h3 id="DWS-层"><a href="#DWS-层" class="headerlink" title="DWS 层"></a>DWS 层</h3><p>DWS 层主要指针对明细粒度的数据进行短周期的汇总。 DWS 公共汇总层是面向分析对<br>象的主题聚集建模。</p><p><strong>最终的分析目标为：最近一天某个类目、某个地区、某类人群购买商品的销售总额、购买力分布。</strong></p><p>因此，我们可以以最终交易成功的商品、买家、地区等角度对最近一天的数据进行组合，组合成为涵盖多个维度的事实宽表。</p><h4 id="建表语句-1"><a href="#建表语句-1" class="headerlink" title="建表语句"></a>建表语句</h4><p>1）临时查询中，执行建表语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`dws_trade_detail_di`</span> (</span><br><span class="line"><span class="string">`user_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'用户 id'</span>,</span><br><span class="line"><span class="string">`sku_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品 Id'</span>,</span><br><span class="line"><span class="string">`user_gender`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'用户性别'</span>,</span><br><span class="line"><span class="string">`user_age`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'用户年龄'</span>,</span><br><span class="line"><span class="string">`user_level`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'用户等级'</span>,</span><br><span class="line"><span class="string">`sku_price`</span> <span class="keyword">double</span> <span class="keyword">COMMENT</span> <span class="string">'商品当日价格'</span>,</span><br><span class="line"><span class="string">`sku_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品名称'</span>,</span><br><span class="line"><span class="string">`sku_category3_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品三级品类 id'</span>,</span><br><span class="line"><span class="string">`sku_category2_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品二级品类 id'</span>,</span><br><span class="line"><span class="string">`sku_category1_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品一级品类 id'</span>,</span><br><span class="line"><span class="string">`sku_category3_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品三级品类名称'</span>,</span><br><span class="line"><span class="string">`sku_category2_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品二级品类名称'</span>,</span><br><span class="line"><span class="string">`sku_category1_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品一级品类名称'</span>,</span><br><span class="line"><span class="string">`spu_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品 spu'</span>,</span><br><span class="line"><span class="string">`tm_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'品牌 id'</span>,</span><br><span class="line"><span class="string">`tm_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'品牌名称'</span>,</span><br><span class="line"><span class="string">`province_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'省市 id'</span>,</span><br><span class="line"><span class="string">`province_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'省市名称'</span>,</span><br><span class="line"><span class="string">`region_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'地区 id'</span>,</span><br><span class="line"><span class="string">`region_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'地区名称'</span>,</span><br><span class="line"><span class="string">`sku_num`</span> <span class="built_in">bigint</span> <span class="keyword">COMMENT</span> <span class="string">'购买个数'</span>,</span><br><span class="line"><span class="string">`order_count`</span> <span class="built_in">bigint</span> <span class="keyword">COMMENT</span> <span class="string">'当日下单单数'</span>,</span><br><span class="line"><span class="string">`order_amount`</span> <span class="keyword">double</span> <span class="keyword">COMMENT</span> <span class="string">'当日下单金额'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">'用户单日交易行为宽表'</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (ds <span class="keyword">string</span>);</span><br></pre></td></tr></table></figure><p>2）在表管理里面查看创建的表</p><p><img data-src="1584891839724.png" alt="查看创建的表"></p><p>3）数据开发-&gt;dws-&gt;导入表</p><p><img data-src="1584891877673.png" alt="导入表"></p><p>4）选择刚创建的所有表</p><p><img data-src="1584891915067.png" alt="选择刚创建的所有表"></p><h3 id="手动将数据导入-DWS-层"><a href="#手动将数据导入-DWS-层" class="headerlink" title="手动将数据导入 DWS 层"></a>手动将数据导入 DWS 层</h3><p>1）在临时查询中执行</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp_trade <span class="keyword">AS</span>  <span class="comment">--方便sql一次执行多次使用</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">od.user_id,od.sku_id,od.province_id,</span><br><span class="line"><span class="keyword">sum</span>(sku_num) sku_num,</span><br><span class="line"><span class="keyword">count</span>(*) order_count,</span><br><span class="line"><span class="keyword">sum</span>(od.order_price*sku_num) order_amount</span><br><span class="line"><span class="keyword">from</span> dwd_order_detail_di od</span><br><span class="line"><span class="keyword">where</span> od.ds=<span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> od.user_id, od.sku_id, od.province_id</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">--多个指标Join多个表</span></span><br><span class="line"><span class="keyword">insert</span> OVERWRITE <span class="keyword">TABLE</span> dws_trade_detail_di <span class="keyword">PARTITION</span></span><br><span class="line">(ds=<span class="string">'$&#123;bizdate&#125;'</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">tmp_trade.user_id,</span><br><span class="line">tmp_trade.sku_id,</span><br><span class="line">u.gender,</span><br><span class="line">months_between(to_char(<span class="keyword">to_date</span>(<span class="string">'$&#123;bizdate&#125;'</span>,<span class="string">'yyyymmdd'</span>),<span class="string">'yy</span></span><br><span class="line"><span class="string">yy-mm-dd'</span>), u.birthday)/<span class="number">12</span> age,</span><br><span class="line">u.user_level,</span><br><span class="line">price,</span><br><span class="line">sku_name,</span><br><span class="line">category3_id,</span><br><span class="line">category2_id,</span><br><span class="line">category1_id,</span><br><span class="line">category3_name,</span><br><span class="line">category2_name,</span><br><span class="line">category1_name,</span><br><span class="line">spu_id,</span><br><span class="line">tm_id,</span><br><span class="line">tm_name,</span><br><span class="line">p.id,</span><br><span class="line">p.province_name,</span><br><span class="line">p.region_id,</span><br><span class="line">p.region_name,</span><br><span class="line">tmp_trade.sku_num,</span><br><span class="line">tmp_trade.order_count,</span><br><span class="line">tmp_trade.order_amount</span><br><span class="line"><span class="keyword">from</span> tmp_trade</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> dim_user_info_df u <span class="keyword">on</span> u.id = tmp_trade.user_id <span class="keyword">and</span></span><br><span class="line">u.ds = <span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> dim_sku_info_df s <span class="keyword">on</span> tmp_trade.sku_id = s.id <span class="keyword">and</span> s.ds</span><br><span class="line">= <span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> dim_base_province_df p <span class="keyword">on</span> tmp_trade.province_id = p.id</span><br><span class="line"><span class="keyword">and</span> p.ds=<span class="string">'$&#123;bizdate&#125;'</span>;</span><br></pre></td></tr></table></figure><p>2）查看结果</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> dws_trade_detail_di <span class="keyword">WHERE</span> ds=<span class="string">'20191008'</span></span><br></pre></td></tr></table></figure><h4 id="数据导入脚本-1"><a href="#数据导入脚本-1" class="headerlink" title="数据导入脚本"></a>数据导入脚本</h4><p>1）编写 dws_trade_detail_di 表脚本<br>（ 1）在流程中加入一个数据开发脚本</p><p><img data-src="1584892575877.png" alt="加入一个数据开发脚本"></p><p>（ 2）新建节点 dws_trade_detail_di_sql</p><p><img data-src="1584892611381.png" alt="新建节点"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp_trade <span class="keyword">AS</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">od.user_id,od.sku_id,od.province_id,</span><br><span class="line"><span class="keyword">sum</span>(sku_num) sku_num,</span><br><span class="line"><span class="keyword">count</span>(*) order_count,</span><br><span class="line"><span class="keyword">sum</span>(od.order_price*sku_num) order_amount</span><br><span class="line"><span class="keyword">from</span> dwd_order_detail_di od</span><br><span class="line"><span class="keyword">where</span> od.ds=<span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> od.user_id, od.sku_id, od.province_id</span><br><span class="line">)</span><br><span class="line"><span class="keyword">insert</span> OVERWRITE <span class="keyword">TABLE</span> dws_trade_detail_di <span class="keyword">PARTITION</span></span><br><span class="line">(ds=<span class="string">'$&#123;bizdate&#125;'</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">tmp_trade.user_id,</span><br><span class="line">tmp_trade.sku_id,</span><br><span class="line">u.gender,</span><br><span class="line">months_between(<span class="string">'$&#123;bizdate&#125;'</span>, u.birthday)/<span class="number">12</span> age,</span><br><span class="line">u.user_level,</span><br><span class="line">price,</span><br><span class="line">sku_name,</span><br><span class="line">category3_id,</span><br><span class="line">category2_id,</span><br><span class="line">category1_id,</span><br><span class="line">category3_name,</span><br><span class="line">category2_name,</span><br><span class="line">category1_name,</span><br><span class="line">spu_id,</span><br><span class="line">tm_id,</span><br><span class="line">tm_name,</span><br><span class="line">p.id,</span><br><span class="line">p.province_name,</span><br><span class="line">p.region_id,</span><br><span class="line">p.region_name,</span><br><span class="line">tmp_trade.sku_num,</span><br><span class="line">tmp_trade.order_count,</span><br><span class="line">tmp_trade.order_amount</span><br><span class="line"><span class="keyword">from</span> tmp_trade</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> dim_user_info_df u <span class="keyword">on</span> u.id = tmp_trade.user_id <span class="keyword">and</span></span><br><span class="line">u.ds = <span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> dim_sku_info_df s <span class="keyword">on</span> tmp_trade.sku_id = s.id <span class="keyword">and</span> s.ds</span><br><span class="line">= <span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> dim_base_province_df p <span class="keyword">on</span> tmp_trade.province_id = p.id</span><br><span class="line"><span class="keyword">and</span> p.ds=<span class="string">'$&#123;bizdate&#125;'</span>;</span><br></pre></td></tr></table></figure><p>（ 2）配置参数<br>点击调度配置-&gt; bizdate=${yyyymmdd}</p><h3 id="ADS-层"><a href="#ADS-层" class="headerlink" title="ADS 层"></a>ADS 层</h3><p>ADS 层主要指针对某一个特定的维度进行的汇总。<br>主要分析三个需求：</p><p>用户各个年龄段统计、地区销售统计、热门商品排行<br>所以主要是针对年龄、地区、商品进行汇总统计，统计四个指标下单数、购买商品个数、<br>销售额、平均客单价。</p><h3 id="建表语句-2"><a href="#建表语句-2" class="headerlink" title="建表语句"></a>建表语句</h3><p>1）临时查询中，执行建表语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ads_trade_age_d`</span> (</span><br><span class="line"><span class="string">`age`</span> <span class="built_in">bigint</span> <span class="keyword">COMMENT</span> <span class="string">'年龄'</span>,</span><br><span class="line"><span class="string">`sku_num`</span> <span class="built_in">bigint</span> <span class="keyword">COMMENT</span> <span class="string">'购买商品个数'</span>,</span><br><span class="line"><span class="string">`order_count`</span> <span class="built_in">bigint</span> <span class="keyword">COMMENT</span> <span class="string">'订单个数'</span>,</span><br><span class="line"><span class="string">`order_amount`</span> <span class="keyword">double</span> <span class="keyword">COMMENT</span> <span class="string">'销售额'</span>,</span><br><span class="line"><span class="string">`avg_amount`</span> <span class="keyword">double</span> <span class="keyword">COMMENT</span> <span class="string">'平均客单价'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">'年龄销售统计'</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (ds <span class="keyword">string</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ads_trade_province_d`</span> (</span><br><span class="line"><span class="string">`province`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'省份 id'</span>,</span><br><span class="line"><span class="string">`province_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'省市名称'</span>,</span><br><span class="line"><span class="string">`region_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'地区 ID'</span>,</span><br><span class="line"><span class="string">`region_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'地区名称'</span>,</span><br><span class="line"><span class="string">`sku_num`</span> <span class="built_in">bigint</span> <span class="keyword">COMMENT</span> <span class="string">'购买商品个数'</span>,</span><br><span class="line"><span class="string">`order_count`</span> <span class="built_in">bigint</span> <span class="keyword">COMMENT</span> <span class="string">'订单个数'</span>,</span><br><span class="line"><span class="string">`order_amount`</span> <span class="keyword">double</span> <span class="keyword">COMMENT</span> <span class="string">'销售额'</span>,</span><br><span class="line"><span class="string">`avg_amount`</span> <span class="keyword">double</span> <span class="keyword">COMMENT</span> <span class="string">'平均客单价'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">'地区销售统计'</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (ds <span class="keyword">string</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ads_trade_sku_d`</span> (</span><br><span class="line"><span class="string">`sku_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品 id'</span>,</span><br><span class="line"><span class="string">`sku_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'商品名称'</span>,</span><br><span class="line"><span class="string">`sku_num`</span> <span class="built_in">bigint</span> <span class="keyword">COMMENT</span> <span class="string">'购买商品个数'</span>,</span><br><span class="line"><span class="string">`category3_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'三级分类 id'</span>,</span><br><span class="line"><span class="string">`category2_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'二级分类 id'</span>,</span><br><span class="line"><span class="string">`category1_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'一级分类 id'</span>,</span><br><span class="line"><span class="string">`category3_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'三级分类名称'</span>,</span><br><span class="line"><span class="string">`category2_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'二级分类名称'</span>,</span><br><span class="line"><span class="string">`category1_name`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'一级分类名称'</span>,</span><br><span class="line"><span class="string">`order_count`</span> <span class="built_in">bigint</span> <span class="keyword">COMMENT</span> <span class="string">'订单个数'</span>,</span><br><span class="line"><span class="string">`order_amount`</span> <span class="keyword">double</span> <span class="keyword">COMMENT</span> <span class="string">'销售额'</span>,</span><br><span class="line"><span class="string">`avg_amount`</span> <span class="keyword">double</span> <span class="keyword">COMMENT</span> <span class="string">'平均客单价'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">'商品销售统计'</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (ds <span class="keyword">string</span>);</span><br></pre></td></tr></table></figure><p>2）在表管理里面查看创建的表</p><p><img data-src="1584892810119.png" alt="查看创建的表"></p><p>3）数据开发-&gt;ads-&gt;导入表</p><p><img data-src="1584892852910.png" alt="导入表"></p><p>4）选择刚创建的所有表</p><p><img data-src="584892876453.png" alt="选择刚创建的所有表"></p><h4 id="手动将数据导入-ADS-层"><a href="#手动将数据导入-ADS-层" class="headerlink" title="手动将数据导入 ADS 层"></a>手动将数据导入 ADS 层</h4><p>1）在临时查询中执行</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> OVERWRITE <span class="keyword">table</span> ads_trade_age_d <span class="keyword">PARTITION</span> (ds =</span><br><span class="line"><span class="string">'$&#123;bizdate&#125;'</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line"><span class="keyword">round</span>(td.user_age) age,</span><br><span class="line"><span class="keyword">sum</span>(sku_num) sku_num,</span><br><span class="line"><span class="keyword">sum</span>(order_count) order_count,</span><br><span class="line"><span class="keyword">sum</span>(order_amount) order_amount,</span><br><span class="line"><span class="keyword">round</span>(<span class="keyword">avg</span>(order_amount),<span class="number">2</span>) avg_amount</span><br><span class="line"><span class="keyword">from</span> dws_trade_detail_di td</span><br><span class="line"><span class="keyword">where</span> ds = <span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">round</span>(td.user_age);</span><br><span class="line"><span class="keyword">insert</span> OVERWRITE <span class="keyword">table</span> ads_trade_province_d <span class="keyword">PARTITION</span> (ds =</span><br><span class="line"><span class="string">'$&#123;bizdate&#125;'</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">td.province_id,td.province_name,td.region_id,td.region_name,</span><br><span class="line"><span class="keyword">sum</span>(sku_num) sku_num,</span><br><span class="line"><span class="keyword">sum</span>(order_count) order_count,</span><br><span class="line"><span class="keyword">sum</span>(order_amount) order_amount,</span><br><span class="line"><span class="keyword">round</span>(<span class="keyword">avg</span>(order_amount),<span class="number">2</span>) avg_amount</span><br><span class="line"><span class="keyword">from</span> dws_trade_detail_di td</span><br><span class="line"><span class="keyword">where</span> ds=<span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">td.province_id,td.province_name,td.region_id,td.region_name;</span><br><span class="line"><span class="keyword">insert</span> OVERWRITE <span class="keyword">table</span> ads_trade_sku_d <span class="keyword">PARTITION</span> (ds =</span><br><span class="line"><span class="string">'$&#123;bizdate&#125;'</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">td.sku_id,td.sku_name,</span><br><span class="line">td.sku_category3_id,</span><br><span class="line">td.sku_category2_id,</span><br><span class="line">td.sku_category1_id,</span><br><span class="line">td.sku_category3_name,</span><br><span class="line">td.sku_category2_name,</span><br><span class="line">td.sku_category1_name,</span><br><span class="line"><span class="keyword">sum</span>(sku_num) sku_num,</span><br><span class="line"><span class="keyword">sum</span>(order_count) order_count,</span><br><span class="line"><span class="keyword">sum</span>(order_amount) order_amount,</span><br><span class="line"><span class="keyword">round</span>(<span class="keyword">avg</span>(order_amount),<span class="number">2</span>) avg_amount</span><br><span class="line"><span class="keyword">from</span> dws_trade_detail_di td</span><br><span class="line"><span class="keyword">where</span> ds = <span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">td.sku_id, td.sku_name, td.sku_category3_id,</span><br><span class="line">td.sku_category2_id, td.sku_category1_id,</span><br><span class="line">td.sku_category3_name, td.sku_category2_name,</span><br><span class="line">td.sku_category1_name;</span><br></pre></td></tr></table></figure><p>2）在临时查询中查询结果</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> ads_trade_age_d <span class="keyword">WHERE</span> ds=<span class="string">'20191008'</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> ads_trade_province_d <span class="keyword">WHERE</span> ds=<span class="string">'20191008'</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> ads_trade_sku_d <span class="keyword">WHERE</span> ds=<span class="string">'20191008'</span>;</span><br></pre></td></tr></table></figure><h4 id="数据导入脚本-2"><a href="#数据导入脚本-2" class="headerlink" title="数据导入脚本"></a>数据导入脚本</h4><p>1）编写 ads_trade_age_d 表脚本<br>（ 1）在流程中加入一个数据开发脚本</p><p><img data-src="1584893015966.png" alt="加入一个数据开发脚本"></p><p>（ 2）新建节点 ads_trade_age_d_sql</p><p><img data-src="1584893058247.png" alt="新建节点"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> OVERWRITE <span class="keyword">table</span> ads_trade_age_d <span class="keyword">PARTITION</span> (ds =</span><br><span class="line"><span class="string">'$&#123;bizdate&#125;'</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line"><span class="keyword">round</span>(td.user_age) age,</span><br><span class="line"><span class="keyword">sum</span>(sku_num) sku_num,</span><br><span class="line"><span class="keyword">sum</span>(order_count) order_count,</span><br><span class="line"><span class="keyword">sum</span>(order_amount) order_amount,</span><br><span class="line"><span class="keyword">round</span>(<span class="keyword">avg</span>(order_amount),<span class="number">2</span>) avg_amount</span><br><span class="line"><span class="keyword">from</span> dws_trade_detail_di td</span><br><span class="line"><span class="keyword">where</span> ds = <span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">round</span>(td.user_age)</span><br></pre></td></tr></table></figure><p>（ 2）配置参数<br>点击调度配置-&gt; bizdate=${yyyymmdd}</p><p>2）编写 ads_trade_province_d 表脚本<br>（ 1）新建节点 ads_trade_province_d_sql</p><p><img data-src="1584893126473.png" alt="新建节点"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> OVERWRITE <span class="keyword">table</span> ads_trade_province_d <span class="keyword">PARTITION</span> (ds =</span><br><span class="line"><span class="string">'$&#123;bizdate&#125;'</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">td.province_id,td.province_name,td.region_id,td.region_name,</span><br><span class="line"><span class="keyword">sum</span>(sku_num) sku_num,</span><br><span class="line"><span class="keyword">sum</span>(order_count) order_count,</span><br><span class="line"><span class="keyword">sum</span>(order_amount) order_amount,</span><br><span class="line"><span class="keyword">round</span>(<span class="keyword">avg</span>(order_amount),<span class="number">2</span>) avg_amount</span><br><span class="line"><span class="keyword">from</span> dws_trade_detail_di td</span><br><span class="line"><span class="keyword">where</span> ds=<span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">td.province_id,td.province_name,td.region_id,td.region_name;</span><br></pre></td></tr></table></figure><p>（ 2）配置参数<br>点击调度配置-&gt; bizdate=${yyyymmdd}</p><p>3）编写 ads_trade_sku_d 表脚本<br>（ 1）新建节点 ads_trade_sku_d_sql</p><p><img data-src="1584893193490.png" alt="新建节点"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> OVERWRITE <span class="keyword">table</span> ads_trade_sku_d <span class="keyword">PARTITION</span> (ds =</span><br><span class="line"><span class="string">'$&#123;bizdate&#125;'</span>)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">td.sku_id,td.sku_name,</span><br><span class="line">td.sku_category3_id,</span><br><span class="line">td.sku_category2_id,</span><br><span class="line">td.sku_category1_id,</span><br><span class="line">td.sku_category3_name,</span><br><span class="line">td.sku_category2_name,</span><br><span class="line">td.sku_category1_name,</span><br><span class="line"><span class="keyword">sum</span>(sku_num) sku_num,</span><br><span class="line"><span class="keyword">sum</span>(order_count) order_count,</span><br><span class="line"><span class="keyword">sum</span>(order_amount) order_amount,</span><br><span class="line"><span class="keyword">round</span>(<span class="keyword">avg</span>(order_amount),<span class="number">2</span>) avg_amount</span><br><span class="line"><span class="keyword">from</span> dws_trade_detail_di td</span><br><span class="line"><span class="keyword">where</span> ds = <span class="string">'$&#123;bizdate&#125;'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">td.sku_id, td.sku_name, td.sku_category3_id,</span><br><span class="line">td.sku_category2_id, td.sku_category1_id,</span><br><span class="line">td.sku_category3_name, td.sku_category2_name,</span><br><span class="line">td.sku_category1_name;</span><br></pre></td></tr></table></figure><p>（ 2）配置参数<br>点击调度配置-&gt; bizdate=${yyyymmdd}</p><h3 id="作业调度"><a href="#作业调度" class="headerlink" title="作业调度"></a>作业调度</h3><p>1）整个业务部分的数仓任务应该包括如下图：</p><p><img data-src="1584893262155.png" alt="整个业务部分的数仓任务"></p><p>2）在原理 ODS 层的基础上继续增加 DWD 层、 DWS 层业务、 ADS 层业务。</p><p><img data-src="1584893324196.png" alt="各层流程图"></p><p><img data-src="1584893428690.png" alt="完整的开发环境界面如下图"></p><p>3）在公共表中预览执行结果</p><p><img data-src="1584893490902.png" alt="公共表中预览执行结果"></p><h3 id="数据导出与作业调度"><a href="#数据导出与作业调度" class="headerlink" title="数据导出与作业调度"></a>数据导出与作业调度</h3><p>将 MaxCompute 中的计算完的结果， 需要导入到 RDS 数据库中， 用于后续的可视化。</p><h4 id="创建结果数据库"><a href="#创建结果数据库" class="headerlink" title="创建结果数据库"></a>创建结果数据库</h4><p>1）在 RDS 服务器中， 新建一个 gmall_adb 数据库，用来保存之后从 MaxCompute 中的结果<br>数据</p><p><img data-src="1584893610335.png" alt="创建数据库表"></p><p>2）建 4 张和 ADS 层结果一样的表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`uv_source_d`</span> (</span><br><span class="line"><span class="string">`source`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'渠道'</span>,</span><br><span class="line"><span class="string">`ct`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'个数'</span>,</span><br><span class="line"><span class="string">`ds`</span> <span class="built_in">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'日期'</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`source`</span>,<span class="string">`ds`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'渠道日活'</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`trade_age_d`</span> (</span><br><span class="line"><span class="string">`age`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'年龄'</span>,</span><br><span class="line"><span class="string">`sku_num`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'购买商品个数'</span>,</span><br><span class="line"><span class="string">`order_count`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单个数'</span>,</span><br><span class="line"><span class="string">`order_amount`</span> <span class="built_in">DECIMAL</span>(<span class="number">16</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'销售额'</span>,</span><br><span class="line"><span class="string">`avg_amount`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'平均客单价'</span>,</span><br><span class="line"><span class="string">`ds`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'日期'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`age`</span>,<span class="string">`ds`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'年龄销售统计'</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> trade_province_d</span><br><span class="line">(</span><br><span class="line">province_id <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'省市 id'</span>,</span><br><span class="line">province_name <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">COMMENT</span> <span class="string">'省市名称'</span>,</span><br><span class="line">region_id <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">COMMENT</span> <span class="string">'地区 ID'</span>,</span><br><span class="line">region_name <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">COMMENT</span> <span class="string">'地区名称'</span>,</span><br><span class="line">sku_num <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">'购买商品个数'</span>,</span><br><span class="line">order_count <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">'订单个数'</span>,</span><br><span class="line">order_amount <span class="built_in">DECIMAL</span>(<span class="number">16</span>,<span class="number">2</span>) <span class="keyword">COMMENT</span> <span class="string">'销售额'</span>,</span><br><span class="line">avg_amount <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">COMMENT</span> <span class="string">'平均客单价'</span>,</span><br><span class="line"><span class="string">`ds`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'日期'</span> ,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`province_id`</span>,<span class="string">`ds`</span>)</span><br><span class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">'地区销售统计'</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`trade_sku`</span> (</span><br><span class="line"><span class="string">`sku_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品 id'</span>,</span><br><span class="line"><span class="string">`sku_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品名称'</span>,</span><br><span class="line"><span class="string">`sku_num`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'购买商品个数'</span>,</span><br><span class="line"><span class="string">`category3_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">COMMENT</span> <span class="string">'三级分类 id'</span>,</span><br><span class="line"><span class="string">`category2_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">COMMENT</span> <span class="string">'二级分类 id'</span>,</span><br><span class="line"><span class="string">`category1_id`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">COMMENT</span> <span class="string">'一级分类 id'</span>,</span><br><span class="line"><span class="string">`category3_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">COMMENT</span> <span class="string">'三级分类名称'</span>,</span><br><span class="line"><span class="string">`category2_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">COMMENT</span> <span class="string">'二级分类名称'</span>,</span><br><span class="line"><span class="string">`category1_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">COMMENT</span> <span class="string">'一级分类名称'</span>,</span><br><span class="line"><span class="string">`order_count`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单个数'</span>,</span><br><span class="line"><span class="string">`order_amount`</span> <span class="built_in">DECIMAL</span>(<span class="number">16</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'销售额'</span>,</span><br><span class="line"><span class="string">`avg_amount`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'平均客单价'</span>,</span><br><span class="line"><span class="string">`ds`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'日期'</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`sku_id`</span>,<span class="string">`ds`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'商品销售统计'</span>;</span><br></pre></td></tr></table></figure><p>3）查看创建好的 4 张表</p><p><img data-src="1584893708266.png" alt="查看创建好的4张表"></p><h4 id="创建商品销售数据同步节点"><a href="#创建商品销售数据同步节点" class="headerlink" title="创建商品销售数据同步节点"></a>创建商品销售数据同步节点</h4><p>将 ADS 层数据导出到 MaxCompute。<br>1）数据开发-&gt;数据集成-&gt;新建数据集成节点-&gt;数据同步</p><p><img data-src="1584893778309.png" alt="数据同步"></p><p>2）新建节点 ads_trade_sku_exp</p><p><img data-src="1584893815043.png" alt="新建节点"></p><p>3）建立连接 RDS 的数据源（由于和之前导入时的 rds 不是一个 databaseName 所以要新建一<br>个）</p><p><img data-src="1584893851471.png" alt="建立连接 RDS 的数据源"></p><p>4）设定要导出的数据库</p><p><img data-src="1584893888320.png" alt="设定要导出的数据库"></p><p>5）加入数据源后刷新菜单可以看到新的数据源</p><p><img data-src="1584893919037.png" alt="查看新的数据源 "></p><p>6）映射部分<br>注意 此处需注意如果想把分区字段导入到目标表中，需要手动添加该分区字段</p><p><img data-src="1584893959779.png" alt="映射字段"></p><p>7）配置参数<br>点击调度配置-&gt; bizdate=${yyyymmdd}</p><p>1）数据开发-&gt;数据集成-&gt;新建数据集成节点-&gt;数据同步<br>2） 创建节点 ads_trade_age_exp</p><p><img data-src="1584894000037.png" alt="创建节点"></p><p>3） 配置年龄统计表导出详情</p><p><img data-src="1584894030944.png" alt="配置年龄统计表导出详情"></p><p>4）配置参数<br>点击调度配置-&gt; bizdate=${yyyymmdd}</p><h4 id="创建省市统计表数据同步节点"><a href="#创建省市统计表数据同步节点" class="headerlink" title="创建省市统计表数据同步节点"></a>创建省市统计表数据同步节点</h4><p>1）数据开发-&gt;数据集成-&gt;新建数据集成节点-&gt;数据同步</p><p>2） 创建节点 ads_trade_province_exp</p><p><img data-src="1584894096874.png" alt="创建节点"></p><p>3）配置省市统计表导出详情</p><p><img data-src="1584894130606.png" alt="配置省市统计表导出详情 "></p><p>4）配置参数<br>点击调度配置-&gt; bizdate=${yyyymmdd}</p><h4 id="创建渠道统计表数据同步节点"><a href="#创建渠道统计表数据同步节点" class="headerlink" title="创建渠道统计表数据同步节点"></a>创建渠道统计表数据同步节点</h4><p>1）数据开发-&gt;数据集成-&gt;新建数据集成节点-&gt;数据同步</p><p>2） 创建节点 ads_uv_source_exp</p><p><img data-src="1584894184531.png" alt="创建节点"></p><p>3）渠道日活统计</p><p><img data-src="1584894213762.png" alt="渠道日活统计"></p><p>4）配置参数<br>点击调度配置-&gt; bizdate=${yyyymmdd}</p><h3 id="作业调度-1"><a href="#作业调度-1" class="headerlink" title="作业调度"></a>作业调度</h3><p>1）把 ADS 层的数据流指向对应的数据导出节点。</p><p><img data-src="1584894302665.png" alt="指向对应的数据导出节点"></p><p>2）执行调度策略</p><p><img data-src="1584894343806.png" alt="点击左上角执行调度策略"></p><p>3）流程跑完之后可以在 MySql RDS 中查看最后统计结果表中的数据 ，如下图</p><p><img data-src="1584894384988.png" alt="查看最后统计结果表中的数据"></p></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/" rel="tag"># 数据仓库</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2020/03/19/ceshi/" rel="prev" title="阿里云Dataworks+Maxcompute实时计算数据仓库方案之用户行为数仓搭建(一)"><i class="fa fa-chevron-left"></i> 阿里云Dataworks+Maxcompute实时计算数据仓库方案之用户行为数仓搭建(一)</a></div><div class="post-nav-item"> <a href="/2020/03/22/ceshi3/" rel="next" title="Flink实时数据仓库系统(一)">Flink实时数据仓库系统(一)<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments" id="valine-comments"></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#业务数仓搭建"><span class="nav-number">1.</span> <span class="nav-text">业务数仓搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#业务数仓架构图"><span class="nav-number">1.1.</span> <span class="nav-text">业务数仓架构图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#业务数仓系统流程设计"><span class="nav-number">1.1.1.</span> <span class="nav-text">业务数仓系统流程设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#业务表结构"><span class="nav-number">1.1.2.</span> <span class="nav-text">业务表结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开发界面"><span class="nav-number">1.1.3.</span> <span class="nav-text">开发界面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#业务数仓分层"><span class="nav-number">1.1.4.</span> <span class="nav-text">业务数仓分层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ODS层"><span class="nav-number">1.1.5.</span> <span class="nav-text">ODS层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据同步"><span class="nav-number">1.1.6.</span> <span class="nav-text">数据同步</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#建立数据同步节点"><span class="nav-number">1.1.6.1.</span> <span class="nav-text">建立数据同步节点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#每日全量表同步"><span class="nav-number">1.1.7.</span> <span class="nav-text">每日全量表同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#每日增量表同步"><span class="nav-number">1.1.8.</span> <span class="nav-text">每日增量表同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#每日新增及变化表同步"><span class="nav-number">1.1.9.</span> <span class="nav-text">每日新增及变化表同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DWD-层"><span class="nav-number">1.1.10.</span> <span class="nav-text">DWD 层</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#建表语句"><span class="nav-number">1.1.10.1.</span> <span class="nav-text">建表语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#手动将数据导入-DWD-层"><span class="nav-number">1.1.10.2.</span> <span class="nav-text">手动将数据导入 DWD 层</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据导入脚本"><span class="nav-number">1.1.11.</span> <span class="nav-text">数据导入脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DWS-层"><span class="nav-number">1.1.12.</span> <span class="nav-text">DWS 层</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#建表语句-1"><span class="nav-number">1.1.12.1.</span> <span class="nav-text">建表语句</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手动将数据导入-DWS-层"><span class="nav-number">1.1.13.</span> <span class="nav-text">手动将数据导入 DWS 层</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#数据导入脚本-1"><span class="nav-number">1.1.13.1.</span> <span class="nav-text">数据导入脚本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ADS-层"><span class="nav-number">1.1.14.</span> <span class="nav-text">ADS 层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#建表语句-2"><span class="nav-number">1.1.15.</span> <span class="nav-text">建表语句</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#手动将数据导入-ADS-层"><span class="nav-number">1.1.15.1.</span> <span class="nav-text">手动将数据导入 ADS 层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据导入脚本-2"><span class="nav-number">1.1.15.2.</span> <span class="nav-text">数据导入脚本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#作业调度"><span class="nav-number">1.1.16.</span> <span class="nav-text">作业调度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据导出与作业调度"><span class="nav-number">1.1.17.</span> <span class="nav-text">数据导出与作业调度</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建结果数据库"><span class="nav-number">1.1.17.1.</span> <span class="nav-text">创建结果数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建商品销售数据同步节点"><span class="nav-number">1.1.17.2.</span> <span class="nav-text">创建商品销售数据同步节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建省市统计表数据同步节点"><span class="nav-number">1.1.17.3.</span> <span class="nav-text">创建省市统计表数据同步节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建渠道统计表数据同步节点"><span class="nav-number">1.1.17.4.</span> <span class="nav-text">创建渠道统计表数据同步节点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#作业调度-1"><span class="nav-number">1.1.18.</span> <span class="nav-text">作业调度</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">易向东</p><div class="site-description" itemprop="description">大数据商务智能(BI)方案设计</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">17</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">2</span> <span class="site-state-item-name">标签</span></div></nav></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">易向东</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span title="站点总字数">146k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">2:13</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><script>
  function leancloudSelector(url) {
    url = encodeURI(url);
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .then(() => {
                leancloudSelector(url).innerText = counter.time + 1;
              })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              })
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=R5lCdvURWRYwXoHUGjSiPegb-gzGzoHsz')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : 'R5lCdvURWRYwXoHUGjSiPegb-gzGzoHsz',
            'X-LC-Key'    : 'GtuKVuaKr00gVSlupac0Ejf8',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });
  </script></div></footer></div><script size="300" alpha="0.6" zindex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script src="/js/algolia-search.js"></script><script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script><script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'R5lCdvURWRYwXoHUGjSiPegb-gzGzoHsz',
      appKey     : 'GtuKVuaKr00gVSlupac0Ejf8',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script><script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/",tagMode:!1})</script></body></html>